<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>견적서 자동 생성</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <form>
    <h1>견적서 자동 생성</h1>
    <p class="description">필수 항목을 입력하여 견적 초안을 만들어 보세요.</p>

    <fieldset>
      <legend>기본 정보</legend>
      <div>
        <label for="companyName">업체명 <span class="required-star">*</span></label>
        <input id="companyName" name="companyName" type="text" placeholder="예: ㈜한빛테크" autocomplete="organization" required>
      </div>
      <div style="margin-top: 12px;">
        <button type="button" id="openContactModal" class="btn-secondary">담당자 정보 입력</button>
        <span id="contactInfoStatus" class="contact-status"></span>
      </div>
    </fieldset>

    <fieldset>
      <legend>금액 정보</legend>
      <div class="two-column">
        <div>
          <label for="monthlyFee">월 이용료 (상품 기준)</label>
          <input id="monthlyFee" type="number" min="0" step="1000" placeholder="자동 계산" readonly>
        </div>
        <div>
          <label for="usageMonths">이용 개월 수</label>
          <input id="usageMonths" type="number" min="1" step="1" value="12">
        </div>
        <div>
          <label for="contractTotal">년 계약총액</label>
          <input id="contractTotal" type="number" min="0" step="1000" placeholder="자동 계산" readonly>
        </div>
        <div>
          <label for="depositAmount">계약금 (세팅비 + 부가서비스)</label>
          <input id="depositAmount" type="number" min="0" step="1000" placeholder="자동 계산" readonly>
        </div>
      </div>
      <div class="total-highlight" aria-live="polite">
        <span>월 이용료: <strong id="monthlyFeeText">₩0 / 월</strong></span>
        <span>년 계약총액: <strong id="contractTotalText">₩0</strong></span>
      </div>
      <p class="note vat-note">모든 비용은 VAT 미포함 기준입니다.</p>
    </fieldset>

    <fieldset>
      <legend>범용 클라우드 상품 선택</legend>
      <label for="cloudPlan">상품 구분</label>
      <select id="cloudPlan">
        <option value="traffic">트래픽 무제한형 (T-스타터)</option>
        <option value="member">회원수 무제한형 (M-스타터)</option>
        <option value="trafficStandard">트래픽 무제한형 (T-스탠다드)</option>
        <option value="memberStandard">회원수 무제한형 (M-스탠다드)</option>
        <option value="trafficProfessional">트래픽 무제한형 (T-프로페셔널)</option>
        <option value="memberProfessional">회원수 무제한형 (M-프로페셔널)</option>
      </select>
      <div class="plan-grid">
        <article id="planSummary" class="plan-summary" aria-live="polite"></article>
      </div>
      <p class="note">상품 선택 시 기본 저장공간 · 전송량 입력값이 자동으로 갱신됩니다.</p>
    </fieldset>

    <fieldset>
      <legend>기본상품 구성</legend>
      <div class="product-list">
        <div class="product-item">
          <div class="product-info">
            <span>범용 클라우드 상품</span>
            <small>선택한 상품 기준 월 이용료</small>
          </div>
          <strong id="planPriceDisplay" class="price-tag">₩0 / 월</strong>
        </div>
        <div class="product-item">
          <div class="product-info">
            <span>동영상 플레이어</span>
            <small>보안 적용 시 월 ₩390,000 추가</small>
          </div>
          <div class="product-addon">
            <label class="checkbox-inline">
              <input type="checkbox" id="securePlayer">
              보안 적용 (+₩390,000/월)
            </label>
            <strong id="securePriceDisplay" class="price-tag">₩0 / 월</strong>
          </div>
        </div>
        <div class="product-item">
          <div class="product-info">
            <span>세팅비</span>
            <small>초기 1회 청구</small>
          </div>
          <strong class="price-tag">₩500,000</strong>
        </div>
      </div>
      <p class="note">※ 기본상품 항목은 필수 포함 항목입니다. 월 이용료는 선택 옵션에 따라 자동 계산됩니다.</p>
    </fieldset>

    <fieldset>
      <legend>저장공간 · 전송량</legend>
      <div class="two-column">
        <div>
          <label for="storageSize">저장공간</label>
          <input id="storageSize" type="text" placeholder="예: 200GB">
        </div>
        <div>
          <label for="bandwidth">전송량</label>
          <input id="bandwidth" type="text" placeholder="예: 2TB/월">
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>부가서비스</legend>
      <p class="note">필요한 항목을 선택해 주세요. (VAT 미포함)</p>
      <div class="service-list">
        <label class="service-item">
          <div>
            <span>PG 전자결제</span>
            <small>1회성 비용 ₩100,000</small>
          </div>
          <input type="checkbox" id="servicePg" data-service-price="100000">
        </label>
        <label class="service-item">
          <div>
            <span>수료증 제작</span>
            <small>1회성 비용 ₩100,000</small>
          </div>
          <input type="checkbox" id="serviceCertificate" data-service-price="100000">
        </label>
        <label class="service-item">
          <div>
            <span>SSO 연동</span>
            <small>1회성 비용 ₩500,000</small>
          </div>
          <input type="checkbox" id="serviceSso" data-service-price="500000">
        </label>
        <label class="service-item">
          <div>
            <span>API 연동</span>
            <small>1회성 비용 ₩500,000</small>
          </div>
          <input type="checkbox" id="serviceApi" data-service-price="500000">
        </label>
      </div>
    </fieldset>

    <div class="submit-row">
      <button type="button" id="generateQuote">임시 견적 생성</button>
      <button type="button" id="printQuote" disabled>PDF 출력</button>
      <button type="button" id="excelQuote" disabled>Excel 출력</button>
    </div>
  </form>

  <section id="quotePreview" class="quote-preview" hidden aria-live="polite">
    <h2>임시 견적서</h2>
    <div class="quote-card">
      <div class="quote-row">
        <span>업체명</span>
        <strong id="previewCompany">-</strong>
      </div>
      <div class="quote-row">
        <span>담당자</span>
        <strong id="previewContact">-</strong>
      </div>
      <div class="quote-row">
        <span>이메일</span>
        <strong id="previewEmail">-</strong>
      </div>
      <div class="quote-row">
        <span>연락처</span>
        <strong id="previewPhone">-</strong>
      </div>
      <div class="quote-row">
        <span>상품 구분</span>
        <strong id="previewPlan">-</strong>
      </div>
      <div class="quote-row">
        <span>월 이용료</span>
        <strong id="previewMonthly">-</strong>
      </div>
      <div class="quote-row">
        <span>이용 기간</span>
        <strong id="previewMonths">-</strong>
      </div>
      <div class="quote-row">
        <span>부가서비스</span>
        <strong id="previewServices">-</strong>
      </div>
      <div class="quote-row total">
        <span>년 계약총액</span>
        <strong id="previewTotal">-</strong>
      </div>
      <div class="quote-row">
        <span>계약금 (세팅비 + 부가서비스)</span>
        <strong id="previewDeposit">-</strong>
      </div>
    </div>
  </section>

  <div id="contactModal" class="modal" hidden>
    <div class="modal-content">
      <div class="modal-header">
        <h3>담당자 정보 입력</h3>
        <button type="button" class="modal-close" id="closeContactModal">&times;</button>
      </div>
      <div class="modal-body">
        <div>
          <label for="modalContactName">담당자 이름 <span class="required-star">*</span></label>
          <input id="modalContactName" type="text" placeholder="예: 김담당" required>
        </div>
        <div>
          <label for="modalContactEmail">이메일 주소 <span class="required-star">*</span></label>
          <input id="modalContactEmail" type="email" placeholder="예: contact@example.com" required>
        </div>
        <div>
          <label for="modalContactPhone">연락처 <span class="required-star">*</span></label>
          <input id="modalContactPhone" type="tel" placeholder="예: 010-0000-0000" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="saveContactInfo" class="btn-primary">저장</button>
        <button type="button" id="cancelContactInfo" class="btn-secondary">취소</button>
      </div>
    </div>
  </div>

  <script>
    const planData = {
      traffic: {
        key: "traffic",
        name: "트래픽 무제한형 (T-스타터)",
        subtitle: "범용 클라우드 LMS",
        price: 500000,
        priceSuffix: "월",
        storage: "100GB",
        bandwidth: "무제한",
        notes: [
          "동영상 월 전송량·웹 트래픽 무제한",
          "누적 회원수 2,000명",
          "개인정보보호 · 실시간 라이브 강의 제공",
          "미리캔버스 디자인 플랫폼 포함"
        ]
      },
      member: {
        key: "member",
        name: "회원수 무제한형 (M-스타터)",
        subtitle: "범용 클라우드 LMS",
        price: 500000,
        priceSuffix: "월",
        storage: "50GB",
        bandwidth: "500GB/월",
        notes: [
          "누적 회원수 무제한",
          "동영상 월 전송량 500GB",
          "웹 트래픽 무제한 및 개인정보보호 제공",
          "미리캔버스 · 실시간 라이브 강의 포함"
        ]
      },
      trafficStandard: {
        key: "trafficStandard",
        name: "트래픽 무제한형 (T-스탠다드)",
        subtitle: "범용 클라우드 LMS",
        price: 700000,
        priceSuffix: "월",
        storage: "150GB",
        bandwidth: "무제한",
        notes: [
          "동영상·웹 트래픽 무제한 (고급 SLA)",
          "누적 회원수 3,000명",
          "개인정보보호 · 정기 구독 및 라이브 강의 포함",
          "전용 기술지원 · 미리캔버스 제공"
        ]
      },
      memberStandard: {
        key: "memberStandard",
        name: "회원수 무제한형 (M-스탠다드)",
        subtitle: "범용 클라우드 LMS",
        price: 700000,
        priceSuffix: "월",
        storage: "100GB",
        bandwidth: "1,000GB/월",
        notes: [
          "누적 회원수 무제한 (고급 분석 포함)",
          "동영상 월 전송량 1,000GB",
          "API 확장 · 개인정보보호 고급옵션 제공",
          "실시간 라이브 · 전담 고객 성공 매니저 배정"
        ]
      },
      trafficProfessional: {
        key: "trafficProfessional",
        name: "트래픽 무제한형 (T-프로페셔널)",
        subtitle: "범용 클라우드 LMS",
        price: 1000000,
        priceSuffix: "월",
        storage: "200GB",
        bandwidth: "무제한",
        notes: [
          "동영상 월 전송량·웹 트래픽 무제한",
          "누적 회원수 5,000명",
          "개인정보보호 · 실시간 라이브 강의 제공",
          "미리캔버스 · 정기 구독 · 포인트 기능 포함",
          "학습 전용 APP 제공"
        ]
      },
      memberProfessional: {
        key: "memberProfessional",
        name: "회원수 무제한형 (M-프로페셔널)",
        subtitle: "범용 클라우드 LMS",
        price: 1000000,
        priceSuffix: "월",
        storage: "100GB",
        bandwidth: "1,500GB/월",
        notes: [
          "누적 회원수 무제한",
          "동영상 월 전송량 1,500GB",
          "웹 트래픽 무제한 및 개인정보보호 제공",
          "미리캔버스 · 정기 구독 · 포인트 기능 포함",
          "실시간 라이브 강의 · 학습 전용 APP 제공"
        ]
      }
    };

    const formatter = new Intl.NumberFormat("ko-KR");
    const quoteForm = document.querySelector("form");
    const companyNameInput = document.getElementById("companyName");
    const contactModal = document.getElementById("contactModal");
    const openContactModalBtn = document.getElementById("openContactModal");
    const closeContactModalBtn = document.getElementById("closeContactModal");
    const saveContactInfoBtn = document.getElementById("saveContactInfo");
    const cancelContactInfoBtn = document.getElementById("cancelContactInfo");
    const contactInfoStatus = document.getElementById("contactInfoStatus");
    const modalContactName = document.getElementById("modalContactName");
    const modalContactEmail = document.getElementById("modalContactEmail");
    const modalContactPhone = document.getElementById("modalContactPhone");
    
    let contactInfo = {
      name: "",
      email: "",
      phone: ""
    };
    const cloudPlanSelect = document.getElementById("cloudPlan");
    const planSummary = document.getElementById("planSummary");
    const storageInput = document.getElementById("storageSize");
    const bandwidthInput = document.getElementById("bandwidth");
    const monthlyFeeInput = document.getElementById("monthlyFee");
    const contractTotalInput = document.getElementById("contractTotal");
    const depositInput = document.getElementById("depositAmount");
    const planPriceDisplay = document.getElementById("planPriceDisplay");
    const securePriceDisplay = document.getElementById("securePriceDisplay");
    const monthlyFeeText = document.getElementById("monthlyFeeText");
    const contractTotalText = document.getElementById("contractTotalText");
    const securePlayerCheckbox = document.getElementById("securePlayer");
    const usageMonthsInput = document.getElementById("usageMonths");
    const serviceCheckboxes = Array.from(document.querySelectorAll("[data-service-price]"));
    const generateButton = document.getElementById("generateQuote");
    const printButton = document.getElementById("printQuote");
    const excelButton = document.getElementById("excelQuote");
    const quotePreview = document.getElementById("quotePreview");
    const previewCompany = document.getElementById("previewCompany");
    const previewContact = document.getElementById("previewContact");
    const previewEmail = document.getElementById("previewEmail");
    const previewPhone = document.getElementById("previewPhone");
    const previewPlan = document.getElementById("previewPlan");
    const previewMonthly = document.getElementById("previewMonthly");
    const previewMonths = document.getElementById("previewMonths");
    const previewServices = document.getElementById("previewServices");
    const previewTotal = document.getElementById("previewTotal");
    const previewDeposit = document.getElementById("previewDeposit");

    const SECURE_VIDEO_MONTHLY = 390000;
    const SETUP_FEE = 500000;

    let lastCalculation = {
      planKey: cloudPlanSelect.value,
      contractTotal: 0,
      monthlyFee: 0,
      depositTotal: 0,
      usageMonths: Number(usageMonthsInput?.value) || 0,
      serviceNames: [],
      securitySelected: false,
      securityFee: 0
    };

    function formatCurrency(amount) {
      return `₩${formatter.format(amount)}`;
    }

    function validateBasicInfo() {
      if (!companyNameInput || !companyNameInput.value.trim()) {
        alert("업체명을 입력하셔야 합니다.");
        companyNameInput?.focus();
        return false;
      }
      
      if (!contactInfo.name || !contactInfo.email || !contactInfo.phone) {
        alert("담당자 정보를 입력하셔야 합니다. '담당자 정보 입력' 버튼을 클릭해 주세요.");
        openContactModalBtn?.focus();
        return false;
      }
      return true;
    }

    function updateContactStatus() {
      if (contactInfo.name && contactInfo.email && contactInfo.phone) {
        contactInfoStatus.textContent = `✓ ${contactInfo.name} (${contactInfo.email})`;
        contactInfoStatus.style.color = "#059669";
      } else {
        contactInfoStatus.textContent = "담당자 정보를 입력해 주세요.";
        contactInfoStatus.style.color = "#dc2626";
      }
    }

    function openModal() {
      if (contactModal) {
        contactModal.hidden = false;
        if (contactInfo.name) modalContactName.value = contactInfo.name;
        if (contactInfo.email) modalContactEmail.value = contactInfo.email;
        if (contactInfo.phone) modalContactPhone.value = contactInfo.phone;
        modalContactName?.focus();
      }
    }

    function closeModal() {
      if (contactModal) {
        contactModal.hidden = true;
      }
    }

    function saveContactInfo() {
      if (!modalContactName || !modalContactName.value.trim()) {
        alert("담당자 이름을 입력해 주세요.");
        modalContactName?.focus();
        return;
      }
      if (!modalContactEmail || !modalContactEmail.value.trim()) {
        alert("이메일 주소를 입력해 주세요.");
        modalContactEmail?.focus();
        return;
      }
      if (!modalContactPhone || !modalContactPhone.value.trim()) {
        alert("연락처를 입력해 주세요.");
        modalContactPhone?.focus();
        return;
      }

      contactInfo = {
        name: modalContactName.value.trim(),
        email: modalContactEmail.value.trim(),
        phone: modalContactPhone.value.trim()
      };
      updateContactStatus();
      closeModal();
    }

    if (openContactModalBtn) {
      openContactModalBtn.addEventListener("click", openModal);
    }
    if (closeContactModalBtn) {
      closeContactModalBtn.addEventListener("click", closeModal);
    }
    if (cancelContactInfoBtn) {
      cancelContactInfoBtn.addEventListener("click", closeModal);
    }
    if (saveContactInfoBtn) {
      saveContactInfoBtn.addEventListener("click", saveContactInfo);
    }
    if (contactModal) {
      contactModal.hidden = true;
      contactModal.addEventListener("click", (e) => {
        if (e.target === contactModal) closeModal();
      });
    }

    updateContactStatus();

    function getUsageMonths() {
      if (!usageMonthsInput) return 0;
      const value = parseInt(usageMonthsInput.value, 10);
      return Number.isFinite(value) && value > 0 ? value : 0;
    }

    function renderPlan(planKey) {
      const plan = planData[planKey];
      if (!plan) return;
      const priceText = `${formatCurrency(plan.price)} / ${plan.priceSuffix}`;
      planSummary.innerHTML = `
        <p class="plan-eyebrow">${plan.subtitle}</p>
        <h3>${plan.name}</h3>
        <div class="plan-price">${priceText}</div>
        <ul>
          ${plan.notes.map(item => `<li>${item}</li>`).join("")}
        </ul>
      `;
      if (storageInput) storageInput.value = plan.storage;
      if (bandwidthInput) bandwidthInput.value = plan.bandwidth;
      calculateTotals(planKey);
    }

    function getSelectedServiceDetails() {
      if (!serviceCheckboxes.length) return [];
      return serviceCheckboxes
        .filter((checkbox) => checkbox.checked)
        .map((checkbox) => {
          const label = checkbox.closest(".service-item");
          const title = label ? label.querySelector("span")?.textContent.trim() : "부가서비스";
          const price = Number(checkbox.dataset.servicePrice || 0);
          return {
            title: title || "부가서비스",
            price: Number.isFinite(price) ? price : 0
          };
        });
    }

    function calculateTotals(planKey = cloudPlanSelect.value) {
      const plan = planData[planKey];
      if (!plan) return;

      const serviceDetails = getSelectedServiceDetails();
      const serviceTotal = serviceDetails.reduce((sum, item) => sum + item.price, 0);
      const usageMonths = getUsageMonths();
      const securityFee = securePlayerCheckbox && securePlayerCheckbox.checked ? SECURE_VIDEO_MONTHLY : 0;

      if (planPriceDisplay) {
        planPriceDisplay.textContent = `${formatCurrency(plan.price)} / 월`;
      }

      if (securePriceDisplay) {
        securePriceDisplay.textContent = securityFee
          ? `${formatCurrency(securityFee)} / 월`
          : "₩0 / 월";
      }

      const monthlyTotal = plan.price + securityFee;
      const contractTotal = usageMonths > 0
        ? (monthlyTotal * usageMonths) + SETUP_FEE + serviceTotal
        : 0;
      const depositTotal = SETUP_FEE + serviceTotal;

      if (monthlyFeeInput) {
        const formatted = monthlyTotal ? formatCurrency(monthlyTotal) : "₩0";
        monthlyFeeInput.value = monthlyTotal || "";
        monthlyFeeInput.style.color = "#111827";
        monthlyFeeInput.setAttribute("data-display", formatted);
      }

      if (monthlyFeeText) {
        monthlyFeeText.textContent = `${formatCurrency(monthlyTotal)} / 월`;
      }

      if (contractTotalInput) {
        const formatted = contractTotal ? formatCurrency(contractTotal) : "₩0";
        contractTotalInput.value = contractTotal || "";
        contractTotalInput.style.color = "#111827";
        contractTotalInput.setAttribute("data-display", formatted);
      }

      if (contractTotalText) {
        contractTotalText.textContent = contractTotal
          ? `${formatCurrency(contractTotal)} (총 ${usageMonths}개월)`
          : "₩0";
      }

      if (depositInput) {
        const formatted = depositTotal ? formatCurrency(depositTotal) : "₩0";
        depositInput.value = depositTotal || "";
        depositInput.style.color = "#111827";
        depositInput.setAttribute("data-display", formatted);
      }

      lastCalculation = {
        planKey,
        contractTotal,
        monthlyFee: monthlyTotal,
        depositTotal,
        usageMonths,
        serviceNames: serviceDetails.map((item) => item.title),
        securitySelected: securityFee > 0,
        securityFee
      };
    }

    cloudPlanSelect.addEventListener("change", (event) => {
      renderPlan(event.target.value);
    });

    if (securePlayerCheckbox) {
      securePlayerCheckbox.addEventListener("change", () => calculateTotals());
    }

    if (usageMonthsInput) {
      usageMonthsInput.addEventListener("input", () => calculateTotals());
    }

    serviceCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", () => calculateTotals());
    });

    function generateQuote() {
      if (!validateBasicInfo()) return;
      if (quoteForm && !quoteForm.reportValidity()) return;
      calculateTotals(cloudPlanSelect.value);

      if (!lastCalculation.contractTotal) {
        alert("이용 개월 수를 올바르게 입력해 주세요.");
        usageMonthsInput?.focus();
        return;
      }

      const plan = planData[lastCalculation.planKey];
      const companyName = companyNameInput?.value?.trim() || "-";
      const services = [...lastCalculation.serviceNames];
      if (lastCalculation.securitySelected) {
        services.push("동영상 플레이어 보안 적용");
      }

      previewCompany.textContent = companyName;
      previewPlan.textContent = plan ? plan.name : "-";
      previewContact.textContent = contactInfo.name || "-";
      previewEmail.textContent = contactInfo.email || "-";
      previewPhone.textContent = contactInfo.phone || "-";
      previewMonthly.textContent = lastCalculation.monthlyFee
        ? `${formatCurrency(lastCalculation.monthlyFee)} / 월`
        : "-";
      previewMonths.textContent = lastCalculation.usageMonths
        ? `${lastCalculation.usageMonths}개월`
        : "-";
      previewServices.textContent = services.length ? services.join(", ") : "선택 없음";
      previewTotal.textContent = formatCurrency(lastCalculation.contractTotal);
      previewDeposit.textContent = formatCurrency(lastCalculation.depositTotal);

      quotePreview.hidden = false;
      printButton.disabled = false;
      excelButton.disabled = false;
      
      sendEmail("임시 견적 생성");
    }

    function openPrintWindow() {
      if (!quotePreview || quotePreview.hidden) return;
      const printWindow = window.open("", "_blank", "width=800,height=600");
      if (!printWindow) return;
      const styles = `
        <style>
          body { font-family: "Noto Sans KR", "Segoe UI", sans-serif; margin: 32px; }
          h2 { margin-top: 0; }
          .quote-card { border: 1px solid #d1d5db; border-radius: 12px; padding: 24px; }
          .quote-row { display: flex; justify-content: space-between; margin-bottom: 12px; }
          .quote-row span { font-weight: 600; color: #374151; }
          .quote-row strong { font-size: 1rem; }
          .quote-row.total { font-size: 1.1rem; }
        </style>
      `;
      printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="ko">
          <head>
            <meta charset="UTF-8">
            <title>임시 견적서</title>
            ${styles}
          </head>
          <body>
            ${quotePreview.innerHTML}
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      
      sendEmail("PDF 출력");
    }

    function exportToExcel() {
      if (!quotePreview || quotePreview.hidden) return;
      const rows = [
        ["업체명", previewCompany.textContent],
        ["담당자", previewContact.textContent],
        ["이메일", previewEmail.textContent],
        ["연락처", previewPhone.textContent],
        ["상품 구분", previewPlan.textContent],
        ["월 이용료", previewMonthly.textContent],
        ["이용 기간", previewMonths.textContent],
        ["부가서비스", previewServices.textContent],
        ["년 계약총액", previewTotal.textContent],
        ["계약금", previewDeposit.textContent]
      ];

      const tableHtml = `
        <table border="1">
          ${rows.map(([label, value]) => `<tr><th>${label}</th><td>${value}</td></tr>`).join("")}
        </table>
      `;

      const blob = new Blob(["\uFEFF" + tableHtml], { type: "application/vnd.ms-excel" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `estimate-${Date.now()}.xls`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      sendEmail("Excel 출력");
    }

    function sendEmail(action) {
      if (!quotePreview || quotePreview.hidden) return;
      
      const emailBody = `
견적서 요청 정보

업체명: ${previewCompany.textContent}
담당자: ${previewContact.textContent}
이메일: ${previewEmail.textContent}
연락처: ${previewPhone.textContent}
상품 구분: ${previewPlan.textContent}
월 이용료: ${previewMonthly.textContent}
이용 기간: ${previewMonths.textContent}
부가서비스: ${previewServices.textContent}
년 계약총액: ${previewTotal.textContent}
계약금: ${previewDeposit.textContent}

작업: ${action}
요청 시간: ${new Date().toLocaleString("ko-KR")}
      `.trim();

      const subject = `[견적서 요청] ${previewCompany.textContent} - ${action}`;
      const mailtoLink = `mailto:consulting@malgnsoft.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
      
      window.location.href = mailtoLink;
    }

    if (generateButton) {
      generateButton.addEventListener("click", generateQuote);
    }

    if (printButton) {
      printButton.addEventListener("click", openPrintWindow);
    }

    if (excelButton) {
      excelButton.addEventListener("click", exportToExcel);
    }

    renderPlan(cloudPlanSelect.value);
  </script>
</body>
</html>


